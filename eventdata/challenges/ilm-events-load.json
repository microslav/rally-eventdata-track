{% set p_event_count = ( (event_count|int) | default(100000000) | int ) %}
{% set p_event_mils = ( (p_event_count|int) / 1000000 ) | round | int %}
{% set p_bulk_indexing_clients = ( (bulk_indexing_clients|int) | default(24) | int ) %}
{% set p_bulk_size = ( (events_per_bulk_request|int) | default(1000) | int ) %}
{% set p_iterations = ( (p_event_count|int) / (p_bulk_size|int) ) | round | int %}
{% set p_iterations_per_client = ( (p_iterations|int) / (p_bulk_indexing_clients|int) ) | round | int %}

{
  "name": "miroslav-{{p_event_mils}}m-load",
  "description": "Indexes {{p_event_mils}} million documents into {{p_query_index_pattern}} indices. IDs are autogenerated by Elasticsearch, meaning there are no conflicts.",
  "default": true,
  "meta": {
    "benchmark_type": "indexing",
    "index_prefix": "{{ p_index_prefix }}", 
    "event_count": "{{ p_event_count }}",
    "client_count": "{{ p_bulk_indexing_clients }}",
    "docs_per_bulk": "{{ p_bulk_size }}"
  },
  "schedule": [
    {
      "operation": "deleteindex_elasticlogs_q-*"
    },
    {
      "operation": "delete-index-template"
    },
    {
      "operation": "create-index-template"
    },
    {
      "operation": {
        "operation-type": "create-index",
        "index": "{{p_query_index_prefix}}-000001",
        "body": {
          "aliases" : {
            "{{p_query_index_write_alias}}" : {}
          }
        }
      }
    },
    {
      "parallel": {
        "completed-by": "index-append-bulk-qwrite",
        "tasks": [
          {
            "operation": "index-append-bulk-qwrite",
            "iterations": {{ p_iterations_per_client }},
            "clients": {{ p_bulk_indexing_clients }},
            "ignore-response-error-level": "{{error_level | default('non-fatal')}}"
          }
        ]
      }
    },
    {
      "operation": "node_storage"
    }
  ]
}
