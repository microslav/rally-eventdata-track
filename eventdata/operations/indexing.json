{# 
BUGBUG
The following track-params are supported:
rollover_max_age: used by the `rollover_custom_alias` operation. Defaults to `1d`.
rollover_max_size: used by the `rollover_custom_alias` operation. Defaults to `30gb`.
max_rolledover_indices: used by the `delete_rolledover_index_pattern` operation. Defaults to `20`.
rolledover_indices_suffix_separator: used by the `delete_rolledover_index_pattern` operation. Defaults to `-`.
BUGBUG
#}

{
  "name": "create_flashfrozen_policy",
  "operation-type": "create-ilm-policy",
  "policy-name": "flashfrozen_ilm_policy",
  "request-params": {
    "master_timeout": "30s",
    "timeout": "30s"
  },
  "body": {
    "policy": {
      "phases": {
          "frozen": {
            "min_age": "1m",
            "actions": {
              "searchable_snapshot": {
                "snapshot_repository": "elastic-s3-repo",
                "force_merge_index": true
              } 
            }
          },
          "hot": {
            "min_age": "0ms",
            "actions": {
              "forcemerge": {
                "max_num_segments": 16
              },
              "rollover": {
                "max_primary_shard_size": "128mb",
                "max_age": "10m",
                "max_primary_shard_docs": 625000
              },
              "set_priority": {
                "priority": 100
              }
            }
          }
      }
    }
  }
},
{
  "name": "create-default-template",
  "operation-type": "create-index-template",
  "template": "elasticlogs-index-template",
  "body": {
    "order": 0,
    "index_patterns": [
      "elasticlogs*"
    ],
    "settings": {
      "index.refresh_interval": "{{p_refresh_interval}}",
      "index.codec": "best_compression",
      {% if (p_translog_sync != 'request') %}
      "index.translog.durability": "async",
      {% endif %}
      {% if (p_disk_type != 'ssd') %}
      "index.merge.scheduler.max_thread_count": 1,
      {% endif %}
      "index.number_of_replicas": {{ number_of_replicas | default(0) }},
      "index.number_of_shards": {{ number_of_shards | default(2) }}
    },
    "mappings": {
      "date_detection": false,
      "dynamic_templates": [
        {
          "fields": {
            "mapping": {
              "type": "keyword"
            },
            "match_mapping_type": "string",
            "path_match": "fields.*"
          }
        },
        {
          "docker.container.labels": {
            "mapping": {
              "type": "keyword"
            },
            "match_mapping_type": "string",
            "path_match": "docker.container.labels.*"
          }
        },
        {
          "strings_as_keyword": {
            "mapping": {
              "ignore_above": 1024,
              "type": "keyword"
            },
            "match_mapping_type": "string"
          }
        }
      ],
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        {%- if record_raw_event_size is defined and record_raw_event_size %}
        "_raw_event_size": {
          "type": "short"
        },
        {%- endif %}
        "source": {
          "type": "keyword",
          "ignore_above": 1024
        },
        "nginx": {
          "properties": {
            "access": {
              "properties": {
                "body_sent": {
                  "properties": {
                    "bytes": {
                      "type": "long"
                    }
                  }
                },
                "referrer": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "user_agent": {
                  "properties": {
                    "device": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "major": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "os_major": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "name": {
                      "type": "keyword",
                      "ignore_above": 1024
                    },
                    "os": {
                      "type": "keyword",
                      "ignore_above": 1024
                    },
                    "os_name": {
                      "type": "keyword",
                      "ignore_above": 1024
                    } 
                  }
                },
                "user_name": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "method": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "url": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "http_version": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "response_code": {
                  "type": "long"
                },
                "geoip": {
                  "properties": {
                    "country_iso_code": {
                      "type": "keyword",
                      "ignore_above": 1024
                    },
                    "location": {
                      "type": "geo_point"
                    },
                    "country_name": {
                      "type": "keyword",
                      "ignore_above": 1024
                    },
                    "city_name": {
                      "type": "keyword",
                      "ignore_above": 1024
                    },
                    "continent_name": {
                      "type": "keyword",
                      "ignore_above": 1024
                    }
                  }
                },
                "remote_ip": {
                  "type": "ip"
                },
                "remote_ip_list": {
                  "type": "ip"
                },
                "agent": {
                  "type": "text",
                  "norms": false
                }
              }
            }
          }
        },
        "beat": {
          "properties": {
            "name": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "hostname": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "version": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        },
        "offset": {
          "type": "long"
        },
        "prospector": {
          "properties": {
            "type": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "input": {
          "properties": {
            "type": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "message": {
          "type": "text",
          "norms": false
        },
        "fileset": {
          "properties": {
            "module": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "name": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        }
      }
    }
  }
},
{
  "name": "create-ilm-template",
  "operation-type": "create-index-template",
  "template": "elasticlogs-index-template",
  "body": {
    "order": 0,
    "index_patterns": [
      "elasticlogs*"
    ],
    "settings": {
      "lifecycle": {
        "name": "flashfrozen_ilm_policy",
        "rollover_alias": "elasticlogs_q_write"
      },
      "translog": {
        "sync_interval": "1s",
        "durability": "async"
      },
      "codec": "best_compression",
      "refresh_interval": "10s",
      "number_of_shards": "16",
      "number_of_replicas": "0"
    },
    "mappings": {
      "dynamic_templates": [
        {
          "fields": {
            "path_match": "fields.*",
            "mapping": {
              "type": "keyword"
            },
            "match_mapping_type": "string"
          }
        },
        {
          "docker.container.labels": {
            "path_match": "docker.container.labels.*",
            "mapping": {
              "type": "keyword"
            },
            "match_mapping_type": "string"
          }
        },
        {
          "strings_as_keyword": {
            "mapping": {
              "ignore_above": 1024,
              "type": "keyword"
            },
            "match_mapping_type": "string"
          }
        }
      ],
      "date_detection": false,
      "properties": {
        "input": {
          "properties": {
            "type": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        },
        "@timestamp": {
          "type": "date"
        },
        "nginx": {
          "properties": {
            "access": {
              "properties": {
                "referrer": {
                  "ignore_above": 1024,
                  "type": "keyword"
                },
                "response_code": {
                  "type": "long"
                },
                "agent": {
                  "norms": false,
                  "type": "text"
                },
                "geoip": {
                  "properties": {
                    "continent_name": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "city_name": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "country_iso_code": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "country_name": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "location": {
                      "type": "geo_point"
                    }
                  }
                },
                "remote_ip": {
                  "type": "ip"
                },
                "method": {
                  "ignore_above": 1024,
                  "type": "keyword"
                },
                "user_name": {
                  "ignore_above": 1024,
                  "type": "keyword"
                },
                "http_version": {
                  "ignore_above": 1024,
                  "type": "keyword"
                },
                "body_sent": {
                  "properties": {
                    "bytes": {
                      "type": "long"
                    }
                  }
                },
                "user_agent": {
                  "properties": {
                    "major": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "os": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "os_major": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "name": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "os_name": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    },
                    "device": {
                      "ignore_above": 1024,
                      "type": "keyword"
                    }
                  }
                },
                "url": {
                  "ignore_above": 1024,
                  "type": "keyword"
                },
                "remote_ip_list": {
                  "type": "ip"
                }
              }
            }
          }
        },
        "offset": {
          "type": "long"
        },
        "beat": {
          "properties": {
            "hostname": {
              "ignore_above": 1024,
              "type": "keyword"
            },
            "name": {
              "ignore_above": 1024,
              "type": "keyword"
            },
            "version": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        },
        "prospector": {
          "properties": {
            "type": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        },
        "source": {
          "ignore_above": 1024,
          "type": "keyword"
        },
        "message": {
          "norms": false,
          "type": "text"
        },
        "fileset": {
          "properties": {
            "module": {
              "ignore_above": 1024,
              "type": "keyword"
            },
            "name": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        }
      }
    },
  }
},
{
  "name": "index-append-1000-elasticlogs_q_write",
  "operation-type": "bulk",
  "param-source": "elasticlogs_bulk",
  "index": "{{p_query_index_write_alias}}",
  "bulk-size": 1000,
  "record_raw_event_size": {{p_record_raw_event_size}}
},
{
  "name": "index-append-bulk-qwrite",
  "operation-type": "bulk",
  "param-source": "elasticlogs_bulk",
  "index": "{{p_query_index_write_alias}}",
  "bulk-size": {{p_bulk_docs}},
  "record_raw_event_size": {{p_record_raw_event_size}}
},
{
  "name": "index-append-1000-elasticlogs_i_write",
  "operation-type": "bulk",
  "param-source": "elasticlogs_bulk",
  "index": "elasticlogs_i_write",
  "bulk-size": 1000,
  "record_raw_event_size": {{p_record_raw_event_size}}
},
{
  "name": "rollover_elasticlogs_q_write_100M",
  "operation-type": "rollover",
  "alias": "{{p_query_index_write_alias}}",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  100000000
    }
  }
},
{
  "name": "rollover_elasticlogs_i_write_100M",
  "operation-type": "rollover",
  "alias": "elasticlogs_i_write",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  100000000
    }
  }
},
{
  "name": "rollover_elasticlogs_q_write_50M",
  "operation-type": "rollover",
  "alias": "{{p_query_index_write_alias}}",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  50000000
    }
  }
},
{
  "name": "rollover_elasticlogs_i_write_50M",
  "operation-type": "rollover",
  "alias": "elasticlogs_i_write",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  50000000
    }
  }
},
{
  "name": "rollover_elasticlogs_q_write_10M",
  "operation-type": "rollover",
  "alias": "{{p_query_index_write_alias}}",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  10000000
    }
  }
},
{
  "name": "rollover_elasticlogs_i_write_10M",
  "operation-type": "rollover",
  "alias": "elasticlogs_i_write",
  "body": {
    "conditions": {
      "max_age":   "1d",
      "max_docs":  10000000
    }
  }
},
{
  "name": "rollover_elasticlogs_q_write_50gb",
  "operation-type": "rollover",
  "alias": "{{p_query_index_write_alias}}",
  "body": {
    "conditions": {
      "max_age": "1d",
      "max_size": "50gb"
    }
  }
},
{
  "name": "rollover_custom_alias",
  "operation-type": "rollover",
  "alias": "{{p_query_index_write_alias}}",
  "body": {
    "conditions": {
      "max_age": {{ rollover_max_age | default("1d") | tojson }},
      "max_size": {{ rollover_max_size | default("30gb") | tojson }}
    }
  }
},
{
  "name": "deleteindex_elasticlogs_i-*",
  "operation-type": "delete-index",
  "index": "elasticlogs_i-*"
},
{
  "name": "deleteindex_elasticlogs_q-*",
  "operation-type": "delete-index",
  "index": "{{p_query_index_pattern}}"
},
{
  "name": "deleteindex_elasticlogs",
  "operation-type": "delete-index",
  "index": "elasticlogs"
},
{
  "name": "delete_rolledover_index_pattern",
  "operation-type": "delete_indices",
  "index_pattern": "{{ p_query_index_pattern }}",
  "max_indices": {{ max_rolledover_indices | default(20) | int | tojson }},
  "suffix_separator": {{ rolledover_indices_suffix_separator | default("-") | tojson }}
}
